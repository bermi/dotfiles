#!/usr/bin/env php
<?php

/**
* This is a script I use to assist me while preparing my timesheets
* 
* This tool will process an export generated by KronoX (http://code.google.com/p/kronox/) 
* which I store at ~/tmp/KronoX-data.txt and will group by project and day of the week.
*
* Example:
*
*   kronox-report -t=5 -f=KronoX-data.txt 
*
* where -t=timezone-offset and -f=kronox-export-file
*/


$options = getopt(
  "t::".  // Timezone offset
  "f::" // Export file
  );

# Offset from your timesheet app timezone
$time_zone_offset = isset($options['t']) ? $options['t'] : 5;

# Path for KronoX exported log
$kronox_export = isset($options['f']) ? $options['f'] : $_SERVER['HOME']."/tmp/KronoX-data.txt";


$row = 1;
$timesheet = array();
if (($handle = fopen(realpath($kronox_export), "r")) !== FALSE) {
    while (($data = fgetcsv($handle, 1000, ",")) !== FALSE) {
        $num = count($data);
        $row++;
        list($start, $end, $minutes, $project, $task) = $data;
        $project = trim($project.' '.str_replace('(null)','', $task));
        $day = date('l', strtotime($start)-(3600*$time_zone_offset));
        if(isset($timesheet[$project]) && isset($timesheet[$project][$day])) {
          $timesheet[$project][$day] += $minutes;
        }else{
          $timesheet[$project][$day] = $minutes;
        }
    }
    fclose($handle);
}

$total_time = 0;
foreach($timesheet as $project => $days)
{
  $total_project = 0;
  echo "\n\n$project";
  echo "\n--------------\n";
  foreach($days as $day => $minutes){
    $total_time += $minutes;
    $total_project += $minutes;
    echo "$day: ".round($minutes/3600, 2)." hours\n";
  }
  echo "\n  Total $project:".(round($total_project/3600, 2))."\n\n";
}

echo "\n\nTotal time: ".round($total_time/3600, 2)."\n";
